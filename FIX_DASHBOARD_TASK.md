# Задание: Исправить неработающий дашборд CryptoBot Pro

## Проблема
Дашборд не работает: график пустой, метрики не отображаются, данные не загружаются.

## Основные проблемы

### 1. Несоответствие экспорта/импорта в `cbp_charts.js`
**Файл:** `web/static/js/cbp_charts.js`

**Проблема:**
- Экспортируется функция `initMainChart(containerElement)`, но в других файлах импортируется и вызывается `initChart()` без параметров
- Отсутствует функция `updateChart(params)`, которая используется в `dashboard.html` и `cbp_dashboard_main.js`
- График показывает только демо-данные, не загружает реальные данные с API

**Требуется:**
1. Добавить функцию `initChart()` которая:
   - Находит элемент `#main-chart` автоматически
   - Вызывает `initMainChart()` с правильным контейнером
   - Инициализирует график с реальными данными, а не только демо

2. Добавить функцию `updateChart(params)` которая:
   - Принимает параметры: `{ symbol, timeframe, exchange, mode?, trades? }`
   - Загружает реальные данные через API `/api/candles` или использует данные из `dashboardState`
   - Обновляет график с новыми свечами
   - Добавляет маркеры сделок (trades) если они переданы
   - Обрабатывает ошибки gracefully (не падает, показывает сообщение)

3. Убрать или сделать опциональными демо-данные - использовать их только если реальных данных нет

### 2. Загрузка данных в график
**Проблема:**
- График не загружает данные из `/api/dashboard/snapshot` или `/api/candles`
- Нужно использовать данные из `dashboardState.candles` или делать отдельный запрос

**Требуется:**
- В `updateChart()` загружать данные через `fetchDashboardSnapshot()` или `/api/candles`
- Конвертировать данные в формат Lightweight Charts: `{ time, open, high, low, close }`
- Валидировать данные перед отображением
- Обрабатывать ошибки сети и пустые ответы

### 3. Инициализация в `dashboard.html`
**Файл:** `web/templates/dashboard.html`

**Проблема:**
- В Alpine.js компоненте вызывается `initChart()` в `setTimeout`, но функция не существует
- Дублирование инициализации: есть и в Alpine.js, и в `cbp_dashboard_main.js`

**Требуется:**
- Убедиться, что `initChart()` вызывается правильно после загрузки DOM
- Убрать дублирование - оставить инициализацию в одном месте (лучше в `cbp_dashboard_main.js`)

### 4. Отображение метрик
**Проблема:**
- Метрики пустые на экране
- Данные загружаются, но не отображаются в Alpine.js компоненте

**Требуется:**
- Убедиться, что `loadDashboardData()` обновляет Alpine.js реактивные переменные
- Проверить, что `dashboardState.setSnapshot()` правильно обновляет состояние
- Убедиться, что Alpine.js `x-text` директивы правильно привязаны к данным

## Файлы для изменения

1. **`web/static/js/cbp_charts.js`** - главный файл для исправления
   - Добавить `initChart()` и `updateChart()`
   - Интегрировать загрузку реальных данных
   - Добавить обработку ошибок

2. **`web/templates/dashboard.html`** - проверить инициализацию
   - Убрать дублирование `initChart()`
   - Убедиться, что данные обновляются в Alpine.js

3. **`web/static/js/cbp_dashboard_main.js`** - проверить интеграцию
   - Убедиться, что `initChart()` вызывается правильно
   - Проверить загрузку данных

## Технические детали

### Формат данных для Lightweight Charts:
```javascript
{
  time: number, // Unix timestamp в секундах
  open: number,
  high: number,
  low: number,
  close: number
}
```

### API Endpoints:
- `/api/dashboard/snapshot?symbol=BTCUSDT&timeframe=15m` - возвращает полный snapshot с candles
- `/api/candles?symbol=BTCUSDT&timeframe=15m&exchange=bybit&limit=500` - возвращает только свечи

### Структура данных из snapshot:
```javascript
{
  candles: [
    { time: number, open: number, high: number, low: number, close: number, volume: number }
  ],
  trades: [...],
  // другие поля
}
```

## Ожидаемый результат

После исправления:
1. ✅ График инициализируется и показывает реальные данные с биржи
2. ✅ Метрики отображаются в верхних карточках
3. ✅ При изменении параметров (символ, таймфрейм) график обновляется
4. ✅ Сделки отображаются на графике маркерами
5. ✅ Нет ошибок в консоли браузера
6. ✅ Данные обновляются автоматически каждые 5 секунд

## Приоритет исправлений

1. **КРИТИЧНО:** Добавить `initChart()` и `updateChart()` в `cbp_charts.js`
2. **КРИТИЧНО:** Интегрировать загрузку реальных данных
3. **ВАЖНО:** Исправить инициализацию в `dashboard.html`
4. **ВАЖНО:** Убедиться, что метрики отображаются

